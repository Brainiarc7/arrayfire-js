"use strict";
var _ = require("lodash");
var Bluebird = require("bluebird");
var async = Bluebird.coroutine;
var debug = require("debug")("af:ann");
var now = require("performance-now");
function ANN(af, layers, range) {
  range = range || 0.05;
  this.af = af;
  this.numLayers = layers.length;
  this.signal = [];
  this.weights = [];
  for (var i = 0; i < this.numLayers; i++) {
    this.signal.push(new af.AFArray());
    if (i < this.numLayers - 1) {
      var w = af.randu(layers[i] + 1, layers[i + 1], af.dType.f32).mul(range).sub(range / 2);
      this.weights.push(w);
    }
  }
}
var proto = ANN.prototype;
proto.deriv = function(out) {
  return out.rhsSub(1).mul(out);
};
proto.addBias = function(input) {
  return this.af.join(1, this.af.constant(1, input.dims(0), this.af.dType.f32), input);
};
proto._calculateError = async($traceurRuntime.initGeneratorFunction(function $__2(out, pred) {
  var dif,
      $__3,
      $__4,
      $__5,
      $__6,
      $__7,
      $__8,
      $__9,
      $__10;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          dif = out.sub(pred);
          $ctx.state = 12;
          break;
        case 12:
          $__3 = Math.sqrt;
          $__4 = this.af;
          $__5 = $__4.sumAsync;
          $__6 = dif.mul;
          $__7 = $__6.call(dif, dif);
          $__8 = $__5.call($__4, $__7);
          $ctx.state = 6;
          break;
        case 6:
          $ctx.state = 2;
          return $__8;
        case 2:
          $__9 = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          $__10 = $__3.call(Math, $__9);
          $ctx.state = 8;
          break;
        case 8:
          $ctx.returnValue = $__10;
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__2, this);
}));
proto.forwardPropagate = function(input) {
  this.signal[0].set(input);
  for (var i = 0; i < this.numLayers - 1; i++) {
    var inVec = this.addBias(this.signal[i]);
    var outVec = this.af.matMul(inVec, this.weights[i]);
    this.signal[i + 1].set(this.af.sigmoid(outVec));
  }
};
proto.backPropagate = function(target, alpha) {
  var af = this.af;
  var Seq = this.af.Seq;
  var outVec = this.signal[this.numLayers - 1];
  var err = outVec.sub(target);
  var m = target.dims(0);
  for (var i = this.numLayers - 2; i >= 0; i--) {
    var inVec = this.addBias(this.signal[i]);
    var delta = af.transpose(this.deriv(outVec).mul(err));
    var grad = af.matMul(delta, inVec).mul(alpha).neg().div(m);
    this.weights[i].addAssign(af.transpose(grad));
    outVec = this.signal[i];
    err.set(this.af.matMulTT(delta, this.weights[i]));
    err.set(err.at(af.span, new Seq(1, outVec.dims(1))));
  }
};
proto.predict = function(input) {
  this.forwardPropagate(input);
  return this.signal[this.numLayers - 1].copy();
};
proto.train = async($traceurRuntime.initGeneratorFunction(function $__11(input, target, options) {
  var af,
      Seq,
      numSamples,
      numBatches,
      err,
      i,
      start,
      j,
      startPos$__0,
      endPos$__1,
      x,
      y,
      startPos,
      endPos,
      outVec,
      end;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          af = this.af;
          Seq = this.af.Seq;
          numSamples = input.dims(0);
          numBatches = numSamples / options.batchSize;
          err = 0;
          $ctx.state = 20;
          break;
        case 20:
          i = 0;
          $ctx.state = 16;
          break;
        case 16:
          $ctx.state = (i < options.maxEpochs) ? 10 : 14;
          break;
        case 6:
          i++;
          $ctx.state = 16;
          break;
        case 10:
          start = now();
          for (j = 0; j < numBatches - 1; j++) {
            startPos$__0 = j * options.batchSize;
            endPos$__1 = startPos$__0 + options.batchSize - 1;
            x = input.at(new Seq(startPos$__0, endPos$__1), af.span);
            y = target.at(new Seq(startPos$__0, endPos$__1), af.span);
            this.forwardPropagate(x);
            this.backPropagate(y, options.alpha);
          }
          startPos = (numBatches - 1) * options.batchSize;
          endPos = numSamples - 1;
          outVec = this.predict(input.at(new Seq(startPos, endPos), af.span));
          $ctx.state = 11;
          break;
        case 11:
          $ctx.state = 2;
          return this._calculateError(outVec, target.at(new Seq(startPos, endPos), af.span));
        case 2:
          err = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          end = now();
          console.log(("Epoch: " + (i + 1) + ", Error: " + err.toFixed(4) + ", Duration: " + ((end - start) / 1000).toFixed(4) + " seconds"));
          $ctx.state = 13;
          break;
        case 13:
          $ctx.state = (err < options.maxError) ? 7 : 6;
          break;
        case 7:
          console.log(("Converged on Epoc: " + (i + 1)));
          $ctx.state = 14;
          break;
        case 14:
          $ctx.returnValue = err;
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__11, this);
}));
module.exports = ANN;
//# sourceMappingURL=data:application/json;base64,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QSxJQUFHLEdBQUcsSUFBSSxDQUFDO0FBR3JCLEFBQUksSUFBQSxDQUFBLE1BQUssRUFBSSxDQUFBLElBQUcsT0FBTyxDQUFFLElBQUcsVUFBVSxFQUFJLEVBQUEsQ0FBQyxDQUFDO0FBQzVDLEFBQUksSUFBQSxDQUFBLEdBQUUsRUFBSSxDQUFBLE1BQUssSUFBSSxBQUFDLENBQUMsTUFBSyxDQUFDLENBQUM7QUFDNUIsQUFBSSxJQUFBLENBQUEsQ0FBQSxFQUFJLENBQUEsTUFBSyxLQUFLLEFBQUMsQ0FBQyxDQUFBLENBQUMsQ0FBQztBQUV0QixhQUFhLENBQUEsSUFBRyxVQUFVLEVBQUksRUFBQSxDQUFHLENBQUEsQ0FBQSxHQUFLLEVBQUEsQ0FBRyxDQUFBLENBQUEsRUFBRSxDQUFHO0FBQzFDLEFBQUksTUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLElBQUcsUUFBUSxBQUFDLENBQUMsSUFBRyxPQUFPLENBQUUsQ0FBQSxDQUFDLENBQUMsQ0FBQztBQUN4QyxBQUFJLE1BQUEsQ0FBQSxLQUFJLEVBQUksQ0FBQSxFQUFDLFVBQVUsQUFBQyxDQUFDLElBQUcsTUFBTSxBQUFDLENBQUMsTUFBSyxDQUFDLElBQUksQUFBQyxDQUFDLEdBQUUsQ0FBQyxDQUFDLENBQUM7QUFHckQsQUFBSSxNQUFBLENBQUEsSUFBRyxFQUFJLENBQUEsRUFBQyxPQUFPLEFBQUMsQ0FBQyxLQUFJLENBQUcsTUFBSSxDQUFDLElBQUksQUFBQyxDQUFDLEtBQUksQ0FBQyxJQUFJLEFBQUMsRUFBQyxJQUFJLEFBQUMsQ0FBQyxDQUFBLENBQUMsQ0FBQztBQUMxRCxPQUFHLFFBQVEsQ0FBRSxDQUFBLENBQUMsVUFBVSxBQUFDLENBQUMsRUFBQyxVQUFVLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQyxDQUFDO0FBRzdDLFNBQUssRUFBSSxDQUFBLElBQUcsT0FBTyxDQUFFLENBQUEsQ0FBQyxDQUFDO0FBQ3ZCLE1BQUUsSUFBSSxBQUFDLENBQUMsSUFBRyxHQUFHLFNBQVMsQUFBQyxDQUFDLEtBQUksQ0FBRyxDQUFBLElBQUcsUUFBUSxDQUFFLENBQUEsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUdqRCxNQUFFLElBQUksQUFBQyxDQUFDLEdBQUUsR0FBRyxBQUFDLENBQUMsRUFBQyxLQUFLLENBQUcsSUFBSSxJQUFFLEFBQUMsQ0FBQyxDQUFBLENBQUcsQ0FBQSxNQUFLLEtBQUssQUFBQyxDQUFDLENBQUEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0VBQ3hEO0FBQUEsQUFDSixDQUFDO0FBRUQsSUFBSSxRQUFRLEVBQUksVUFBVSxLQUFJLENBQUc7QUFDN0IsS0FBRyxpQkFBaUIsQUFBQyxDQUFDLEtBQUksQ0FBQyxDQUFDO0FBQzVCLE9BQU8sQ0FBQSxJQUFHLE9BQU8sQ0FBRSxJQUFHLFVBQVUsRUFBSSxFQUFBLENBQUMsS0FBSyxBQUFDLEVBQUMsQ0FBQztBQUNqRCxDQUFDO0FBRUQsSUFBSSxNQUFNLEVBQUksQ0FBQSxLQUFJLEFBQUMsQ0E5RW5CLGVBQWMsc0JBQXNCLEFBQUMsQ0E4RWpCLGVBQVUsS0FBSSxDQUFHLENBQUEsTUFBSyxDQUFHLENBQUEsT0FBTTs7Ozs7Ozs7Ozs7Ozs7Ozs7QUE5RW5ELE9BQU8sQ0FBUCxlQUFjLHdCQUF3QixBQUFkLENBQXhCLFNBQVMsSUFBRyxDQUFHO0FBQ1QsVUFBTyxJQUFHOzs7YUE4RUgsQ0FBQSxJQUFHLEdBQUc7Y0FDTCxDQUFBLElBQUcsR0FBRyxJQUFJO3FCQUVILENBQUEsS0FBSSxLQUFLLEFBQUMsQ0FBQyxDQUFBLENBQUM7cUJBQ1osQ0FBQSxVQUFTLEVBQUksQ0FBQSxPQUFNLFVBQVU7Y0FFcEMsRUFBQTs7OztZQUVHLEVBQUE7Ozs7QUF2RmpCLGFBQUcsTUFBTSxFQUFJLENBQUEsQ0F1Rk8sQ0FBQSxFQUFJLENBQUEsT0FBTSxVQUFVLENBdkZULFVBQXdDLENBQUM7QUFDaEUsZUFBSTs7QUFzRitCLFVBQUEsRUFBRTs7OztnQkFDdkIsQ0FBQSxHQUFFLEFBQUMsRUFBQztBQUNsQixpQkFBYSxFQUFBLENBQUcsQ0FBQSxDQUFBLEVBQUksQ0FBQSxVQUFTLEVBQUksRUFBQSxDQUFHLENBQUEsQ0FBQSxFQUFFLENBQUc7eUJBQ3RCLENBQUEsQ0FBQSxFQUFJLENBQUEsT0FBTSxVQUFVO3VCQUN0QixDQUFBLGNBQVcsQ0FBQSxPQUFNLFVBQVUsQ0FBQSxDQUFJLEVBQUE7Y0FFcEMsQ0FBQSxLQUFJLEdBQUcsQUFBQyxDQUFDLEdBQUksSUFBRSxBQUFDLDBCQUFpQixDQUFHLENBQUEsRUFBQyxLQUFLLENBQUM7Y0FDM0MsQ0FBQSxNQUFLLEdBQUcsQUFBQyxDQUFDLEdBQUksSUFBRSxBQUFDLDBCQUFpQixDQUFHLENBQUEsRUFBQyxLQUFLLENBQUM7QUFFcEQsZUFBRyxpQkFBaUIsQUFBQyxDQUFDLENBQUEsQ0FBQyxDQUFDO0FBQ3hCLGVBQUcsY0FBYyxBQUFDLENBQUMsQ0FBQSxDQUFHLENBQUEsT0FBTSxNQUFNLENBQUMsQ0FBQztVQUN4QztBQUFBLG1CQUdlLENBQUEsQ0FBQyxVQUFTLEVBQUksRUFBQSxDQUFDLEVBQUksQ0FBQSxPQUFNLFVBQVU7aUJBQ3JDLENBQUEsVUFBUyxFQUFJLEVBQUE7aUJBQ2IsQ0FBQSxJQUFHLFFBQVEsQUFBQyxDQUFDLEtBQUksR0FBRyxBQUFDLENBQUMsR0FBSSxJQUFFLEFBQUMsQ0FBQyxRQUFPLENBQUcsT0FBSyxDQUFDLENBQUcsQ0FBQSxFQUFDLEtBQUssQ0FBQyxDQUFDOzs7OztlQUMxRCxDQUFBLElBQUcsZ0JBQWdCLEFBQUMsQ0FBQyxNQUFLLENBQUcsQ0FBQSxNQUFLLEdBQUcsQUFBQyxDQUFDLEdBQUksSUFBRSxBQUFDLENBQUMsUUFBTyxDQUFHLE9BQUssQ0FBQyxDQUFHLENBQUEsRUFBQyxLQUFLLENBQUMsQ0FBQzs7QUFBdEYsWUFBRSxFQXhHVixDQUFBLElBQUcsS0FBSyxBQXdHc0YsQ0FBQTs7OztjQUMxRSxDQUFBLEdBQUUsQUFBQyxFQUFDO0FBRWhCLGdCQUFNLElBQUksQUFBQyxFQUFDLFNBQVMsSUFBQyxDQUFBLEVBQUksRUFBQSxHQUFDLFlBQVcsRUFBQyxDQUFBLEdBQUUsUUFBUSxBQUFDLENBQUMsQ0FBQSxDQUFDLENBQUEsQ0FBQyxlQUFjLEVBQUMsQ0FBQSxDQUFDLENBQUMsR0FBRSxFQUFJLE1BQUksQ0FBQyxFQUFJLEtBQUcsQ0FBQyxRQUFRLEFBQUMsQ0FBQyxDQUFBLENBQUMsQ0FBQSxDQUFDLFdBQVMsRUFBQyxDQUFDOzs7O0FBM0d4SCxhQUFHLE1BQU0sRUFBSSxDQUFBLENBOEdELEdBQUUsRUFBSSxDQUFBLE9BQU0sU0FBUyxDQTlHRixRQUF3QyxDQUFDO0FBQ2hFLGVBQUk7O0FBOEdBLGdCQUFNLElBQUksQUFBQyxFQUFDLHFCQUFxQixJQUFDLENBQUEsRUFBSSxFQUFBLEdBQUcsQ0FBQzs7OztBQS9HdEQsYUFBRyxZQUFZLEVBb0hKLElBQUUsQUFwSHNCLENBQUE7Ozs7QUFBbkMsZUFBTyxDQUFBLElBQUcsSUFBSSxBQUFDLEVBQUMsQ0FBQTs7QUFDbUIsRUFDL0IsUUFBNkIsS0FBRyxDQUFDLENBQUM7QUFtSHRDLENBckh1RCxDQXFIdEQsQ0FBQztBQUVGLEtBQUssUUFBUSxFQUFJLElBQUUsQ0FBQztBQUFBIiwiZmlsZSI6Im1hY2hpbmUtbGVhcm5pbmcvYW5uLmpzIiwic291cmNlUm9vdCI6ImV4YW1wbGVzL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgQmx1ZWJpcmQgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XG5sZXQgYXN5bmMgPSBCbHVlYmlyZC5jb3JvdXRpbmU7XG5sZXQgZGVidWcgPSByZXF1aXJlKFwiZGVidWdcIikoXCJhZjphbm5cIik7XG5sZXQgbm93ID0gcmVxdWlyZShcInBlcmZvcm1hbmNlLW5vd1wiKTtcblxuZnVuY3Rpb24gQU5OKGFmLCBsYXllcnMsIHJhbmdlKSB7XG4gICAgcmFuZ2UgPSByYW5nZSB8fCAwLjA1O1xuICAgIHRoaXMuYWYgPSBhZjtcbiAgICB0aGlzLm51bUxheWVycyA9IGxheWVycy5sZW5ndGg7XG4gICAgdGhpcy5zaWduYWwgPSBbXTtcbiAgICB0aGlzLndlaWdodHMgPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMubnVtTGF5ZXJzOyBpKyspIHtcbiAgICAgICAgdGhpcy5zaWduYWwucHVzaChuZXcgYWYuQUZBcnJheSgpKTtcbiAgICAgICAgaWYgKGkgPCB0aGlzLm51bUxheWVycyAtIDEpIHtcbiAgICAgICAgICAgIGxldCB3ID0gYWYucmFuZHUobGF5ZXJzW2ldICsgMSwgbGF5ZXJzW2kgKyAxXSwgYWYuZFR5cGUuZjMyKS5tdWwocmFuZ2UpLnN1YihyYW5nZSAvIDIpO1xuICAgICAgICAgICAgdGhpcy53ZWlnaHRzLnB1c2godyk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmxldCBwcm90byA9IEFOTi5wcm90b3R5cGU7XG5cbnByb3RvLmRlcml2ID0gZnVuY3Rpb24gKG91dCkge1xuICAgIHJldHVybiBvdXQucmhzU3ViKDEpLm11bChvdXQpO1xufTtcblxucHJvdG8uYWRkQmlhcyA9IGZ1bmN0aW9uIChpbnB1dCkge1xuICAgIHJldHVybiB0aGlzLmFmLmpvaW4oMSwgdGhpcy5hZi5jb25zdGFudCgxLCBpbnB1dC5kaW1zKDApLCB0aGlzLmFmLmRUeXBlLmYzMiksIGlucHV0KTtcbn07XG5cbnByb3RvLl9jYWxjdWxhdGVFcnJvciA9IGFzeW5jKGZ1bmN0aW9uKihvdXQsIHByZWQpIHtcbiAgICBsZXQgZGlmID0gb3V0LnN1YihwcmVkKTtcbiAgICByZXR1cm4gTWF0aC5zcXJ0KHlpZWxkIHRoaXMuYWYuc3VtQXN5bmMoZGlmLm11bChkaWYpKSk7XG59KTtcblxucHJvdG8uZm9yd2FyZFByb3BhZ2F0ZSA9IGZ1bmN0aW9uIChpbnB1dCkge1xuICAgIHRoaXMuc2lnbmFsWzBdLnNldChpbnB1dCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLm51bUxheWVycyAtIDE7IGkrKykge1xuICAgICAgICBsZXQgaW5WZWMgPSB0aGlzLmFkZEJpYXModGhpcy5zaWduYWxbaV0pO1xuICAgICAgICBsZXQgb3V0VmVjID0gdGhpcy5hZi5tYXRNdWwoaW5WZWMsIHRoaXMud2VpZ2h0c1tpXSk7XG4gICAgICAgIHRoaXMuc2lnbmFsW2kgKyAxXS5zZXQodGhpcy5hZi5zaWdtb2lkKG91dFZlYykpO1xuICAgIH1cbn07XG5cbnByb3RvLmJhY2tQcm9wYWdhdGUgPSBmdW5jdGlvbiAodGFyZ2V0LCBhbHBoYSkge1xuICAgIGxldCBhZiA9IHRoaXMuYWY7XG4gICAgbGV0IFNlcSA9IHRoaXMuYWYuU2VxO1xuXG4gICAgLy8gR2V0IGVycm9yIGZvciBvdXRwdXQgbGF5ZXJcbiAgICBsZXQgb3V0VmVjID0gdGhpcy5zaWduYWxbdGhpcy5udW1MYXllcnMgLSAxXTtcbiAgICBsZXQgZXJyID0gb3V0VmVjLnN1Yih0YXJnZXQpO1xuICAgIGxldCBtID0gdGFyZ2V0LmRpbXMoMCk7XG5cbiAgICBmb3IgKGxldCBpID0gdGhpcy5udW1MYXllcnMgLSAyOyBpID49IDA7IGktLSkge1xuICAgICAgICBsZXQgaW5WZWMgPSB0aGlzLmFkZEJpYXModGhpcy5zaWduYWxbaV0pO1xuICAgICAgICBsZXQgZGVsdGEgPSBhZi50cmFuc3Bvc2UodGhpcy5kZXJpdihvdXRWZWMpLm11bChlcnIpKTtcblxuICAgICAgICAvLyBBZGp1c3Qgd2VpZ2h0c1xuICAgICAgICBsZXQgZ3JhZCA9IGFmLm1hdE11bChkZWx0YSwgaW5WZWMpLm11bChhbHBoYSkubmVnKCkuZGl2KG0pO1xuICAgICAgICB0aGlzLndlaWdodHNbaV0uYWRkQXNzaWduKGFmLnRyYW5zcG9zZShncmFkKSk7XG5cbiAgICAgICAgLy8gSW5wdXQgdG8gY3VycmVudCBsYXllciBpcyBvdXRwdXQgb2YgcHJldmlvdXNcbiAgICAgICAgb3V0VmVjID0gdGhpcy5zaWduYWxbaV07XG4gICAgICAgIGVyci5zZXQodGhpcy5hZi5tYXRNdWxUVChkZWx0YSwgdGhpcy53ZWlnaHRzW2ldKSk7XG5cbiAgICAgICAgLy8gUmVtb3ZlIHRoZSBlcnJvciBvZiBiaWFzIGFuZCBwcm9wYWdhdGUgYmFja3dhcmRcbiAgICAgICAgZXJyLnNldChlcnIuYXQoYWYuc3BhbiwgbmV3IFNlcSgxLCBvdXRWZWMuZGltcygxKSkpKTtcbiAgICB9XG59O1xuXG5wcm90by5wcmVkaWN0ID0gZnVuY3Rpb24gKGlucHV0KSB7XG4gICAgdGhpcy5mb3J3YXJkUHJvcGFnYXRlKGlucHV0KTtcbiAgICByZXR1cm4gdGhpcy5zaWduYWxbdGhpcy5udW1MYXllcnMgLSAxXS5jb3B5KCk7XG59O1xuXG5wcm90by50cmFpbiA9IGFzeW5jKGZ1bmN0aW9uKihpbnB1dCwgdGFyZ2V0LCBvcHRpb25zKSB7XG4gICAgbGV0IGFmID0gdGhpcy5hZjtcbiAgICBsZXQgU2VxID0gdGhpcy5hZi5TZXE7XG5cbiAgICBsZXQgbnVtU2FtcGxlcyA9IGlucHV0LmRpbXMoMCk7XG4gICAgbGV0IG51bUJhdGNoZXMgPSBudW1TYW1wbGVzIC8gb3B0aW9ucy5iYXRjaFNpemU7XG5cbiAgICBsZXQgZXJyID0gMDtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3B0aW9ucy5tYXhFcG9jaHM7IGkrKykge1xuICAgICAgICBjb25zdCBzdGFydCA9IG5vdygpO1xuICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IG51bUJhdGNoZXMgLSAxOyBqKyspIHtcbiAgICAgICAgICAgIGxldCBzdGFydFBvcyA9IGogKiBvcHRpb25zLmJhdGNoU2l6ZTtcbiAgICAgICAgICAgIGxldCBlbmRQb3MgPSBzdGFydFBvcyArIG9wdGlvbnMuYmF0Y2hTaXplIC0gMTtcblxuICAgICAgICAgICAgbGV0IHggPSBpbnB1dC5hdChuZXcgU2VxKHN0YXJ0UG9zLCBlbmRQb3MpLCBhZi5zcGFuKTtcbiAgICAgICAgICAgIGxldCB5ID0gdGFyZ2V0LmF0KG5ldyBTZXEoc3RhcnRQb3MsIGVuZFBvcyksIGFmLnNwYW4pO1xuXG4gICAgICAgICAgICB0aGlzLmZvcndhcmRQcm9wYWdhdGUoeCk7XG4gICAgICAgICAgICB0aGlzLmJhY2tQcm9wYWdhdGUoeSwgb3B0aW9ucy5hbHBoYSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBWYWxpZGF0ZSB3aXRoIGxhc3QgYmF0Y2hcbiAgICAgICAgbGV0IHN0YXJ0UG9zID0gKG51bUJhdGNoZXMgLSAxKSAqIG9wdGlvbnMuYmF0Y2hTaXplO1xuICAgICAgICBsZXQgZW5kUG9zID0gbnVtU2FtcGxlcyAtIDE7XG4gICAgICAgIGxldCBvdXRWZWMgPSB0aGlzLnByZWRpY3QoaW5wdXQuYXQobmV3IFNlcShzdGFydFBvcywgZW5kUG9zKSwgYWYuc3BhbikpO1xuICAgICAgICBlcnIgPSB5aWVsZCB0aGlzLl9jYWxjdWxhdGVFcnJvcihvdXRWZWMsIHRhcmdldC5hdChuZXcgU2VxKHN0YXJ0UG9zLCBlbmRQb3MpLCBhZi5zcGFuKSk7XG4gICAgICAgIGNvbnN0IGVuZCA9IG5vdygpO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKGBFcG9jaDogJHtpICsgMX0sIEVycm9yOiAke2Vyci50b0ZpeGVkKDQpfSwgRHVyYXRpb246ICR7KChlbmQgLSBzdGFydCkgLyAxMDAwKS50b0ZpeGVkKDQpfSBzZWNvbmRzYCk7XG5cbiAgICAgICAgLy8gQ2hlY2sgaWYgY29udmVyZ2VuY2UgY3JpdGVyaWEgaGFzIGJlZW4gbWV0XG4gICAgICAgIGlmIChlcnIgPCBvcHRpb25zLm1heEVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgQ29udmVyZ2VkIG9uIEVwb2M6ICR7aSArIDF9YCk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBlcnI7XG59KTtcblxubW9kdWxlLmV4cG9ydHMgPSBBTk47Il19
