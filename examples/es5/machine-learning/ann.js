"use strict";
"use strict";
var _ = require("lodash");
var Bluebird = require("bluebird");
var async = Bluebird.coroutine;
var debug = require("debug")("af:ann");
var now = require("performance-now");
function ANN(af, layers, range) {
  range = range || 0.05;
  this.af = af;
  this.numLayers = layers.length;
  this.signal = [];
  this.weights = [];
  for (var i = 0; i < this.numLayers; i++) {
    this.signal.push(new af.AFArray());
    if (i < this.numLayers - 1) {
      var w = af.randu(layers[i] + 1, layers[i + 1], af.dType.f32).mul(range).sub(range / 2);
      this.weights.push(w);
    }
  }
}
var proto = ANN.prototype;
proto.sigmoid = function(val) {
  return this.af.exp(val.neg()).add(1).rhsDiv(1);
};
proto.deriv = function(out) {
  return out.rhsSub(1).mul(out);
};
proto.addBias = function(input) {
  return this.af.join(1, this.af.constant(1, input.dims(0), this.af.dType.f32), input);
};
proto._calculateError = async($traceurRuntime.initGeneratorFunction(function $__2(out, pred) {
  var dif,
      $__3,
      $__4,
      $__5,
      $__6,
      $__7,
      $__8,
      $__9,
      $__10;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          dif = out.sub(pred);
          $ctx.state = 12;
          break;
        case 12:
          $__3 = Math.sqrt;
          $__4 = this.af;
          $__5 = $__4.sumAsync;
          $__6 = dif.mul;
          $__7 = $__6.call(dif, dif);
          $__8 = $__5.call($__4, $__7);
          $ctx.state = 6;
          break;
        case 6:
          $ctx.state = 2;
          return $__8;
        case 2:
          $__9 = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          $__10 = $__3.call(Math, $__9);
          $ctx.state = 8;
          break;
        case 8:
          $ctx.returnValue = $__10;
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__2, this);
}));
proto.forwardPropagate = function(input) {
  this.signal[0].set(input);
  for (var i = 0; i < this.numLayers - 1; i++) {
    var inVec = this.addBias(this.signal[i]);
    var outVec = this.af.matMul(inVec, this.weights[i]);
    this.signal[i + 1].set(this.sigmoid(outVec));
  }
};
proto.backPropagate = function(target, alpha) {
  var af = this.af;
  var Seq = this.af.Seq;
  var outVec = this.signal[this.numLayers - 1];
  var err = outVec.sub(target);
  var m = target.dims(0);
  for (var i = this.numLayers - 2; i >= 0; i--) {
    var inVec = this.addBias(this.signal[i]);
    var delta = af.transpose(this.deriv(outVec).mul(err));
    var grad = af.matMul(delta, inVec).mul(alpha).neg().div(m);
    this.weights[i].addAssign(af.transpose(grad));
    outVec = this.signal[i];
    err.set(af.transpose(this.af.matMul(this.weights[i], delta)));
    err.set(err.at(af.span, new Seq(1, outVec.dims(1))));
  }
};
proto.predict = function(input) {
  this.forwardPropagate(input);
  return this.signal[this.numLayers - 1].copy();
};
proto.train = async($traceurRuntime.initGeneratorFunction(function $__11(input, target, options) {
  var af,
      Seq,
      numSamples,
      numBatches,
      err,
      i,
      start,
      j,
      startPos$__0,
      endPos$__1,
      x,
      y,
      startPos,
      endPos,
      outVec,
      end;
  return $traceurRuntime.createGeneratorInstance(function($ctx) {
    while (true)
      switch ($ctx.state) {
        case 0:
          af = this.af;
          Seq = this.af.Seq;
          numSamples = input.dims(0);
          numBatches = numSamples / options.batchSize;
          err = 0;
          $ctx.state = 20;
          break;
        case 20:
          i = 0;
          $ctx.state = 16;
          break;
        case 16:
          $ctx.state = (i < options.maxEpochs) ? 10 : 14;
          break;
        case 6:
          i++;
          $ctx.state = 16;
          break;
        case 10:
          start = now();
          for (j = 0; j < numBatches - 1; j++) {
            startPos$__0 = j * options.batchSize;
            endPos$__1 = startPos$__0 + options.batchSize;
            x = input.at(new Seq(startPos$__0, endPos$__1), af.span);
            y = target.at(new Seq(startPos$__0, endPos$__1), af.span);
            this.forwardPropagate(x);
            this.backPropagate(y, options.alpha);
          }
          startPos = (numBatches - 1) * options.batchSize;
          endPos = numSamples - 1;
          outVec = this.predict(input.at(new Seq(startPos, endPos), af.span));
          $ctx.state = 11;
          break;
        case 11:
          $ctx.state = 2;
          return this._calculateError(outVec, target.at(new Seq(startPos, endPos), af.span));
        case 2:
          err = $ctx.sent;
          $ctx.state = 4;
          break;
        case 4:
          end = now();
          console.log(("Epoch: " + (i + 1) + ", Error: " + err.toFixed(4) + ", Duration: " + ((end - start) / 1000).toFixed(4) + " seconds"));
          $ctx.state = 13;
          break;
        case 13:
          $ctx.state = (err < options.maxError) ? 7 : 6;
          break;
        case 7:
          console.log(("Converged on Epoc: " + (i + 1)));
          $ctx.state = 14;
          break;
        case 14:
          $ctx.returnValue = err;
          $ctx.state = -2;
          break;
        default:
          return $ctx.end();
      }
  }, $__11, this);
}));
module.exports = ANN;
//# sourceMappingURL=data:application/json;base64,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Qzs7QUFBdEYsWUFBRSxFQTdHVixDQUFBLElBQUcsS0FBSyxBQTZHc0YsQ0FBQTs7OztjQUMxRSxDQUFBLEdBQUUsQUFBQyxFQUFDO0FBRWhCLGdCQUFNLElBQUksQUFBQyxFQUFDLFNBQVMsSUFBQyxDQUFBLEVBQUksRUFBQSxHQUFDLFlBQVcsRUFBQyxDQUFBLEdBQUUsUUFBUSxBQUFDLENBQUMsQ0FBQSxDQUFDLENBQUEsQ0FBQyxlQUFjLEVBQUMsQ0FBQSxDQUFDLENBQUMsR0FBRSxFQUFJLE1BQUksQ0FBQyxFQUFJLEtBQUcsQ0FBQyxRQUFRLEFBQUMsQ0FBQyxDQUFBLENBQUMsQ0FBQSxDQUFDLFdBQVMsRUFBQyxDQUFDOzs7O0FBaEh4SCxhQUFHLE1BQU0sRUFBSSxDQUFBLENBbUhELEdBQUUsRUFBSSxDQUFBLE9BQU0sU0FBUyxDQW5IRixRQUF3QyxDQUFDO0FBQ2hFLGVBQUk7O0FBbUhBLGdCQUFNLElBQUksQUFBQyxFQUFDLHFCQUFxQixJQUFDLENBQUEsRUFBSSxFQUFBLEdBQUcsQ0FBQzs7OztBQXBIdEQsYUFBRyxZQUFZLEVBeUhKLElBQUUsQUF6SHNCLENBQUE7Ozs7QUFBbkMsZUFBTyxDQUFBLElBQUcsSUFBSSxBQUFDLEVBQUMsQ0FBQTs7QUFDbUIsRUFDL0IsUUFBNkIsS0FBRyxDQUFDLENBQUM7QUF3SHRDLENBMUh1RCxDQTBIdEQsQ0FBQztBQUVGLEtBQUssUUFBUSxFQUFJLElBQUUsQ0FBQztBQUFBIiwiZmlsZSI6Im1hY2hpbmUtbGVhcm5pbmcvYW5uLmpzIiwic291cmNlUm9vdCI6ImV4YW1wbGVzL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgQmx1ZWJpcmQgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XG5sZXQgYXN5bmMgPSBCbHVlYmlyZC5jb3JvdXRpbmU7XG5sZXQgZGVidWcgPSByZXF1aXJlKFwiZGVidWdcIikoXCJhZjphbm5cIik7XG5sZXQgbm93ID0gcmVxdWlyZShcInBlcmZvcm1hbmNlLW5vd1wiKTtcblxuZnVuY3Rpb24gQU5OKGFmLCBsYXllcnMsIHJhbmdlKSB7XG4gICAgcmFuZ2UgPSByYW5nZSB8fCAwLjA1O1xuICAgIHRoaXMuYWYgPSBhZjtcbiAgICB0aGlzLm51bUxheWVycyA9IGxheWVycy5sZW5ndGg7XG4gICAgdGhpcy5zaWduYWwgPSBbXTtcbiAgICB0aGlzLndlaWdodHMgPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMubnVtTGF5ZXJzOyBpKyspIHtcbiAgICAgICAgdGhpcy5zaWduYWwucHVzaChuZXcgYWYuQUZBcnJheSgpKTtcbiAgICAgICAgaWYgKGkgPCB0aGlzLm51bUxheWVycyAtIDEpIHtcbiAgICAgICAgICAgIGxldCB3ID0gYWYucmFuZHUobGF5ZXJzW2ldICsgMSwgbGF5ZXJzW2kgKyAxXSwgYWYuZFR5cGUuZjMyKS5tdWwocmFuZ2UpLnN1YihyYW5nZSAvIDIpO1xuICAgICAgICAgICAgdGhpcy53ZWlnaHRzLnB1c2godyk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmxldCBwcm90byA9IEFOTi5wcm90b3R5cGU7XG5cbnByb3RvLnNpZ21vaWQgPSBmdW5jdGlvbiAodmFsKSB7XG4gICAgLy8gMSAvICgxICsgZXhwKC12YWwpKTtcbiAgICByZXR1cm4gdGhpcy5hZi5leHAodmFsLm5lZygpKS5hZGQoMSkucmhzRGl2KDEpO1xufTtcblxucHJvdG8uZGVyaXYgPSBmdW5jdGlvbiAob3V0KSB7XG4gICAgcmV0dXJuIG91dC5yaHNTdWIoMSkubXVsKG91dCk7XG59O1xuXG5wcm90by5hZGRCaWFzID0gZnVuY3Rpb24gKGlucHV0KSB7XG4gICAgcmV0dXJuIHRoaXMuYWYuam9pbigxLCB0aGlzLmFmLmNvbnN0YW50KDEsIGlucHV0LmRpbXMoMCksIHRoaXMuYWYuZFR5cGUuZjMyKSwgaW5wdXQpO1xufTtcblxucHJvdG8uX2NhbGN1bGF0ZUVycm9yID0gYXN5bmMoZnVuY3Rpb24qKG91dCwgcHJlZCkge1xuICAgIGxldCBkaWYgPSBvdXQuc3ViKHByZWQpO1xuICAgIHJldHVybiBNYXRoLnNxcnQoeWllbGQgdGhpcy5hZi5zdW1Bc3luYyhkaWYubXVsKGRpZikpKTtcbn0pO1xuXG5wcm90by5mb3J3YXJkUHJvcGFnYXRlID0gZnVuY3Rpb24gKGlucHV0KSB7XG4gICAgdGhpcy5zaWduYWxbMF0uc2V0KGlucHV0KTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMubnVtTGF5ZXJzIC0gMTsgaSsrKSB7XG4gICAgICAgIGxldCBpblZlYyA9IHRoaXMuYWRkQmlhcyh0aGlzLnNpZ25hbFtpXSk7XG4gICAgICAgIGxldCBvdXRWZWMgPSB0aGlzLmFmLm1hdE11bChpblZlYywgdGhpcy53ZWlnaHRzW2ldKTtcbiAgICAgICAgdGhpcy5zaWduYWxbaSArIDFdLnNldCh0aGlzLnNpZ21vaWQob3V0VmVjKSk7XG4gICAgfVxufTtcblxucHJvdG8uYmFja1Byb3BhZ2F0ZSA9IGZ1bmN0aW9uICh0YXJnZXQsIGFscGhhKSB7XG4gICAgbGV0IGFmID0gdGhpcy5hZjtcbiAgICBsZXQgU2VxID0gdGhpcy5hZi5TZXE7XG5cbiAgICAvLyBHZXQgZXJyb3IgZm9yIG91dHB1dCBsYXllclxuICAgIGxldCBvdXRWZWMgPSB0aGlzLnNpZ25hbFt0aGlzLm51bUxheWVycyAtIDFdO1xuICAgIGxldCBlcnIgPSBvdXRWZWMuc3ViKHRhcmdldCk7XG4gICAgbGV0IG0gPSB0YXJnZXQuZGltcygwKTtcblxuICAgIGZvciAobGV0IGkgPSB0aGlzLm51bUxheWVycyAtIDI7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgIGxldCBpblZlYyA9IHRoaXMuYWRkQmlhcyh0aGlzLnNpZ25hbFtpXSk7XG4gICAgICAgIGxldCBkZWx0YSA9IGFmLnRyYW5zcG9zZSh0aGlzLmRlcml2KG91dFZlYykubXVsKGVycikpO1xuXG4gICAgICAgIC8vIEFkanVzdCB3ZWlnaHRzXG4gICAgICAgIGxldCBncmFkID0gYWYubWF0TXVsKGRlbHRhLCBpblZlYykubXVsKGFscGhhKS5uZWcoKS5kaXYobSk7XG4gICAgICAgIHRoaXMud2VpZ2h0c1tpXS5hZGRBc3NpZ24oYWYudHJhbnNwb3NlKGdyYWQpKTtcblxuICAgICAgICAvLyBJbnB1dCB0byBjdXJyZW50IGxheWVyIGlzIG91dHB1dCBvZiBwcmV2aW91c1xuICAgICAgICBvdXRWZWMgPSB0aGlzLnNpZ25hbFtpXTtcbiAgICAgICAgZXJyLnNldChhZi50cmFuc3Bvc2UodGhpcy5hZi5tYXRNdWwodGhpcy53ZWlnaHRzW2ldLCBkZWx0YSkpKTtcblxuICAgICAgICAvLyBSZW1vdmUgdGhlIGVycm9yIG9mIGJpYXMgYW5kIHByb3BhZ2F0ZSBiYWNrd2FyZFxuICAgICAgICBlcnIuc2V0KGVyci5hdChhZi5zcGFuLCBuZXcgU2VxKDEsIG91dFZlYy5kaW1zKDEpKSkpO1xuICAgIH1cbn07XG5cbnByb3RvLnByZWRpY3QgPSBmdW5jdGlvbiAoaW5wdXQpIHtcbiAgICB0aGlzLmZvcndhcmRQcm9wYWdhdGUoaW5wdXQpO1xuICAgIHJldHVybiB0aGlzLnNpZ25hbFt0aGlzLm51bUxheWVycyAtIDFdLmNvcHkoKTtcbn07XG5cbnByb3RvLnRyYWluID0gYXN5bmMoZnVuY3Rpb24qKGlucHV0LCB0YXJnZXQsIG9wdGlvbnMpIHtcbiAgICBsZXQgYWYgPSB0aGlzLmFmO1xuICAgIGxldCBTZXEgPSB0aGlzLmFmLlNlcTtcblxuICAgIGxldCBudW1TYW1wbGVzID0gaW5wdXQuZGltcygwKTtcbiAgICBsZXQgbnVtQmF0Y2hlcyA9IG51bVNhbXBsZXMgLyBvcHRpb25zLmJhdGNoU2l6ZTtcblxuICAgIGxldCBlcnIgPSAwO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvcHRpb25zLm1heEVwb2NoczsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHN0YXJ0ID0gbm93KCk7XG4gICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbnVtQmF0Y2hlcyAtIDE7IGorKykge1xuICAgICAgICAgICAgbGV0IHN0YXJ0UG9zID0gaiAqIG9wdGlvbnMuYmF0Y2hTaXplO1xuICAgICAgICAgICAgbGV0IGVuZFBvcyA9IHN0YXJ0UG9zICsgb3B0aW9ucy5iYXRjaFNpemU7XG5cbiAgICAgICAgICAgIGxldCB4ID0gaW5wdXQuYXQobmV3IFNlcShzdGFydFBvcywgZW5kUG9zKSwgYWYuc3Bhbik7XG4gICAgICAgICAgICBsZXQgeSA9IHRhcmdldC5hdChuZXcgU2VxKHN0YXJ0UG9zLCBlbmRQb3MpLCBhZi5zcGFuKTtcblxuICAgICAgICAgICAgdGhpcy5mb3J3YXJkUHJvcGFnYXRlKHgpO1xuICAgICAgICAgICAgdGhpcy5iYWNrUHJvcGFnYXRlKHksIG9wdGlvbnMuYWxwaGEpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVmFsaWRhdGUgd2l0aCBsYXN0IGJhdGNoXG4gICAgICAgIGxldCBzdGFydFBvcyA9IChudW1CYXRjaGVzIC0gMSkgKiBvcHRpb25zLmJhdGNoU2l6ZTtcbiAgICAgICAgbGV0IGVuZFBvcyA9IG51bVNhbXBsZXMgLSAxO1xuICAgICAgICBsZXQgb3V0VmVjID0gdGhpcy5wcmVkaWN0KGlucHV0LmF0KG5ldyBTZXEoc3RhcnRQb3MsIGVuZFBvcyksIGFmLnNwYW4pKTtcbiAgICAgICAgZXJyID0geWllbGQgdGhpcy5fY2FsY3VsYXRlRXJyb3Iob3V0VmVjLCB0YXJnZXQuYXQobmV3IFNlcShzdGFydFBvcywgZW5kUG9zKSwgYWYuc3BhbikpO1xuICAgICAgICBjb25zdCBlbmQgPSBub3coKTtcblxuICAgICAgICBjb25zb2xlLmxvZyhgRXBvY2g6ICR7aSArIDF9LCBFcnJvcjogJHtlcnIudG9GaXhlZCg0KX0sIER1cmF0aW9uOiAkeygoZW5kIC0gc3RhcnQpIC8gMTAwMCkudG9GaXhlZCg0KX0gc2Vjb25kc2ApO1xuXG4gICAgICAgIC8vIENoZWNrIGlmIGNvbnZlcmdlbmNlIGNyaXRlcmlhIGhhcyBiZWVuIG1ldFxuICAgICAgICBpZiAoZXJyIDwgb3B0aW9ucy5tYXhFcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYENvbnZlcmdlZCBvbiBFcG9jOiAke2kgKyAxfWApO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZXJyO1xufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gQU5OOyJdfQ==
