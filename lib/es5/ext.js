"use strict";
"use strict";
var Bluebird = require("bluebird");
var _ = require("lodash");
var async = Bluebird.coroutine;
var retryCount = 5;
var gcTime = 1000;
function isOutOfMemoryError(e) {
  return e.message.indexOf("998") > 0;
}
function invokeGC(af) {
  af.gc(gcTime);
}
function synchronify(af, f) {
  return function() {
    var err;
    var res;
    var done;
    var cb = function(e, r) {
      err = e;
      res = r;
      done = true;
    };
    var args = _.toArray(arguments).concat(cb);
    for (var i = 0; i < retryCount; i++) {
      done = false;
      f.apply(this, args);
      while (!done)
        af._doEvents();
      if (err) {
        if (!isOutOfMemoryError(err)) {
          throw err;
        } else {
          invokeGC(af);
        }
      }
    }
    if (err)
      throw err;
    return res;
  };
}
function installAsyncAndSync(af, obj, name) {
  if (_.isUndefined(name)) {
    var $__3 = true;
    var $__4 = false;
    var $__5 = undefined;
    try {
      for (var $__1 = void 0,
          $__0 = (_.keys(obj))[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
        var key = $__1.value;
        {
          installAsyncAndSync(af, obj, key);
        }
      }
    } catch ($__6) {
      $__4 = true;
      $__5 = $__6;
    } finally {
      try {
        if (!$__3 && $__0.return != null) {
          $__0.return();
        }
      } finally {
        if ($__4) {
          throw $__5;
        }
      }
    }
    return;
  }
  if (name !== "AFArray") {
    var f = obj[name];
    if (_.isFunction(f)) {
      if (!_.isFunction(obj[name + "Async"])) {
        obj[name + "Async"] = async($traceurRuntime.initGeneratorFunction(function $__7() {
          var self,
              args,
              call,
              err,
              i,
              $__8,
              $__9,
              e;
          var $arguments = arguments;
          return $traceurRuntime.createGeneratorInstance(function($ctx) {
            while (true)
              switch ($ctx.state) {
                case 0:
                  self = this;
                  args = _.toArray($arguments);
                  call = function() {
                    return new Bluebird(function(resolve, reject) {
                      var cb = function(e, r) {
                        if (e) {
                          reject(e);
                        } else {
                          resolve(r);
                        }
                      };
                      args.push(cb);
                      f.apply(self, args);
                    });
                  };
                  err = null;
                  $ctx.state = 22;
                  break;
                case 22:
                  i = 0;
                  $ctx.state = 20;
                  break;
                case 20:
                  $ctx.state = (i < retryCount) ? 11 : 18;
                  break;
                case 14:
                  i++;
                  $ctx.state = 20;
                  break;
                case 11:
                  $ctx.pushTry(9, null);
                  $ctx.state = 12;
                  break;
                case 12:
                  $__8 = call();
                  $ctx.state = 6;
                  break;
                case 6:
                  $ctx.state = 2;
                  return $__8;
                case 2:
                  $__9 = $ctx.sent;
                  $ctx.state = 4;
                  break;
                case 4:
                  $ctx.returnValue = $__9;
                  $ctx.state = -2;
                  break;
                case 8:
                  $ctx.popTry();
                  $ctx.state = 14;
                  break;
                case 9:
                  $ctx.popTry();
                  $ctx.maybeUncatchable();
                  e = $ctx.storedException;
                  $ctx.state = 15;
                  break;
                case 15:
                  if (!isOutOfMemoryError(e)) {
                    throw e;
                  }
                  invokeGC(af);
                  err = e;
                  $ctx.state = 14;
                  break;
                case 18:
                  throw err;
                  $ctx.state = -2;
                  break;
                default:
                  return $ctx.end();
              }
          }, $__7, this);
        }));
      }
      if (!_.isFunction(obj[name + "Sync"])) {
        obj[name + "Sync"] = synchronify(af, f);
      }
      obj[name] = function() {
        var err = null;
        for (var i = 0; i < retryCount; i++) {
          try {
            return f.apply(this, arguments);
          } catch (e) {
            if (!isOutOfMemoryError(e)) {
              throw e;
            }
            invokeGC(af);
            err = e;
          }
        }
        throw err;
      };
    }
  }
}
function ext(af) {
  installAsyncAndSync(af, af);
  installAsyncAndSync(af, af.AFArray);
  installAsyncAndSync(af, af.AFArray.prototype);
  _.extend(af, {
    end: -1,
    span: null,
    all: -1,
    dtype: require("./dtype"),
    dType: require("./dtype"),
    source: require("./source"),
    matchType: require("./matchType"),
    cSpace: require("./cSpace"),
    CSpace: require("./cSpace"),
    connectivity: require("./connectivity"),
    borderType: require("./borderType"),
    interpType: require("./interpType"),
    matProp: require("./matProp"),
    normType: require("./normType"),
    convMode: require("./convMode"),
    convDomain: require("./convDomain"),
    Dim4: require("./dim4"),
    Seq: require("./seq"),
    Complex: require("./complex"),
    Row: require("./row"),
    Col: require("./col"),
    Rows: require("./rows"),
    Cols: require("./cols"),
    getDevices: function() {
      var current = this.getDevice();
      try {
        var count = this.getDeviceCount();
        var result = [];
        for (var i = 0; i < count; i++) {
          this.setDevice(i);
          var info = this.deviceInfo();
          info.id = i;
          result.push(info);
        }
        return result;
      } finally {
        this.setDevice(current);
      }
    },
    gfor: require("./makeGfor")(af)
  });
}
module.exports = ext;
//# sourceMappingURL=data:application/json;base64,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ZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiLypcbkNvcHlyaWdodCAoYykgMjAxNC0yMDE1LCBBcnJheUZpcmVcbkNvcHlyaWdodCAoYykgMjAxNSBHw6Fib3IgTWV6xZEgYWthIHVuYm9ybmNoaWtrZW4gKGdhYm9yLm1lem9Ab3V0bG9vay5jb20pXG5BbGwgcmlnaHRzIHJlc2VydmVkLlxuXG5SZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXQgbW9kaWZpY2F0aW9uLFxuYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OlxuXG4gKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UsIHRoaXNcbiAgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuXG5cbiAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSwgdGhpc1xuICBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGUgZG9jdW1lbnRhdGlvbiBhbmQvb3JcbiAgb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi5cblxuICogTmVpdGhlciB0aGUgbmFtZSBvZiB0aGUgQXJyYXlGaXJlIG5vciB0aGUgbmFtZXMgb2YgaXRzXG4gIGNvbnRyaWJ1dG9ycyBtYXkgYmUgdXNlZCB0byBlbmRvcnNlIG9yIHByb21vdGUgcHJvZHVjdHMgZGVyaXZlZCBmcm9tXG4gIHRoaXMgc29mdHdhcmUgd2l0aG91dCBzcGVjaWZpYyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uXG5cblRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgXCJBUyBJU1wiIEFORFxuQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRURcbldBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkVcbkRJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBDT1BZUklHSFQgSE9MREVSIE9SIENPTlRSSUJVVE9SUyBCRSBMSUFCTEUgRk9SXG5BTlkgRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVNcbihJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUztcbkxPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORCBPTlxuQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksIE9SIFRPUlRcbihJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRSBPRiBUSElTXG5TT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS5cbiovXG5cblwidXNlIHN0cmljdFwiO1xuXG5sZXQgQmx1ZWJpcmQgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgYXN5bmMgPSBCbHVlYmlyZC5jb3JvdXRpbmU7XG5cbmNvbnN0IHJldHJ5Q291bnQgPSA1O1xuY29uc3QgZ2NUaW1lID0gMTAwMDtcblxuZnVuY3Rpb24gaXNPdXRPZk1lbW9yeUVycm9yKGUpIHtcbiAgICByZXR1cm4gZS5tZXNzYWdlLmluZGV4T2YoXCI5OThcIikgPiAwO1xufVxuXG5mdW5jdGlvbiBpbnZva2VHQyhhZikge1xuICAgIGFmLmdjKGdjVGltZSk7XG59XG5cbmZ1bmN0aW9uIHN5bmNocm9uaWZ5KGFmLCBmKSB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIGVycjtcbiAgICAgICAgdmFyIHJlcztcbiAgICAgICAgdmFyIGRvbmU7XG4gICAgICAgIGxldCBjYiA9IGZ1bmN0aW9uIChlLCByKSB7XG4gICAgICAgICAgICBlcnIgPSBlO1xuICAgICAgICAgICAgcmVzID0gcjtcbiAgICAgICAgICAgIGRvbmUgPSB0cnVlO1xuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBhcmdzID0gXy50b0FycmF5KGFyZ3VtZW50cykuY29uY2F0KGNiKTtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJldHJ5Q291bnQ7IGkrKykge1xuICAgICAgICAgICAgZG9uZSA9IGZhbHNlO1xuICAgICAgICAgICAgZi5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICAgICAgICAgIHdoaWxlICghZG9uZSkgYWYuX2RvRXZlbnRzKCk7XG5cbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWlzT3V0T2ZNZW1vcnlFcnJvcihlcnIpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGludm9rZUdDKGFmKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXJyKSB0aHJvdyBlcnI7XG5cbiAgICAgICAgcmV0dXJuIHJlcztcbiAgICB9O1xufVxuXG5mdW5jdGlvbiBpbnN0YWxsQXN5bmNBbmRTeW5jKGFmLCBvYmosIG5hbWUpIHtcbiAgICBpZiAoXy5pc1VuZGVmaW5lZChuYW1lKSkge1xuICAgICAgICBmb3IgKGxldCBrZXkgb2YgXy5rZXlzKG9iaikpIHtcbiAgICAgICAgICAgIGluc3RhbGxBc3luY0FuZFN5bmMoYWYsIG9iaiwga2V5KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKG5hbWUgIT09IFwiQUZBcnJheVwiKSB7XG4gICAgICAgIGxldCBmID0gb2JqW25hbWVdO1xuICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKGYpKSB7XG4gICAgICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihvYmpbbmFtZSArIFwiQXN5bmNcIl0pKSB7XG4gICAgICAgICAgICAgICAgb2JqW25hbWUgKyBcIkFzeW5jXCJdID0gYXN5bmMoZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHNlbGYgPSB0aGlzO1xuICAgICAgICAgICAgICAgICAgICBsZXQgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgY2FsbCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQmx1ZWJpcmQoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBjYiA9IGZ1bmN0aW9uIChlLCByKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goY2IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYuYXBwbHkoc2VsZiwgYXJncyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCBlcnIgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJldHJ5Q291bnQ7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4geWllbGQgY2FsbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzT3V0T2ZNZW1vcnlFcnJvcihlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZva2VHQyhhZik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyID0gZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihvYmpbbmFtZSArIFwiU3luY1wiXSkpIHtcbiAgICAgICAgICAgICAgICBvYmpbbmFtZSArIFwiU3luY1wiXSA9IHN5bmNocm9uaWZ5KGFmLCBmKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG9ialtuYW1lXSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBsZXQgZXJyID0gbnVsbDtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJldHJ5Q291bnQ7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGYuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc091dE9mTWVtb3J5RXJyb3IoZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaW52b2tlR0MoYWYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZXJyID0gZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgfVxufVxuXG5mdW5jdGlvbiBleHQoYWYpIHtcbiAgICBpbnN0YWxsQXN5bmNBbmRTeW5jKGFmLCBhZik7XG4gICAgaW5zdGFsbEFzeW5jQW5kU3luYyhhZiwgYWYuQUZBcnJheSk7XG4gICAgaW5zdGFsbEFzeW5jQW5kU3luYyhhZiwgYWYuQUZBcnJheS5wcm90b3R5cGUpO1xuXG4gICAgXy5leHRlbmQoYWYsIHtcbiAgICAgICAgZW5kOiAtMSxcbiAgICAgICAgc3BhbjogbnVsbCxcbiAgICAgICAgYWxsOiAtMSxcbiAgICAgICAgZHR5cGU6IHJlcXVpcmUoXCIuL2R0eXBlXCIpLFxuICAgICAgICBkVHlwZTogcmVxdWlyZShcIi4vZHR5cGVcIiksXG4gICAgICAgIHNvdXJjZTogcmVxdWlyZShcIi4vc291cmNlXCIpLFxuICAgICAgICBtYXRjaFR5cGU6IHJlcXVpcmUoXCIuL21hdGNoVHlwZVwiKSxcbiAgICAgICAgY1NwYWNlOiByZXF1aXJlKFwiLi9jU3BhY2VcIiksXG4gICAgICAgIENTcGFjZTogcmVxdWlyZShcIi4vY1NwYWNlXCIpLFxuICAgICAgICBjb25uZWN0aXZpdHk6IHJlcXVpcmUoXCIuL2Nvbm5lY3Rpdml0eVwiKSxcbiAgICAgICAgYm9yZGVyVHlwZTogcmVxdWlyZShcIi4vYm9yZGVyVHlwZVwiKSxcbiAgICAgICAgaW50ZXJwVHlwZTogcmVxdWlyZShcIi4vaW50ZXJwVHlwZVwiKSxcbiAgICAgICAgbWF0UHJvcDogcmVxdWlyZShcIi4vbWF0UHJvcFwiKSxcbiAgICAgICAgbm9ybVR5cGU6IHJlcXVpcmUoXCIuL25vcm1UeXBlXCIpLFxuICAgICAgICBjb252TW9kZTogcmVxdWlyZShcIi4vY29udk1vZGVcIiksXG4gICAgICAgIGNvbnZEb21haW46IHJlcXVpcmUoXCIuL2NvbnZEb21haW5cIiksXG4gICAgICAgIERpbTQ6IHJlcXVpcmUoXCIuL2RpbTRcIiksXG4gICAgICAgIFNlcTogcmVxdWlyZShcIi4vc2VxXCIpLFxuICAgICAgICBDb21wbGV4OiByZXF1aXJlKFwiLi9jb21wbGV4XCIpLFxuICAgICAgICBSb3c6IHJlcXVpcmUoXCIuL3Jvd1wiKSxcbiAgICAgICAgQ29sOiByZXF1aXJlKFwiLi9jb2xcIiksXG4gICAgICAgIFJvd3M6IHJlcXVpcmUoXCIuL3Jvd3NcIiksXG4gICAgICAgIENvbHM6IHJlcXVpcmUoXCIuL2NvbHNcIiksXG4gICAgICAgIGdldERldmljZXM6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGxldCBjdXJyZW50ID0gdGhpcy5nZXREZXZpY2UoKTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgbGV0IGNvdW50ID0gdGhpcy5nZXREZXZpY2VDb3VudCgpO1xuICAgICAgICAgICAgICAgIGxldCByZXN1bHQgPSBbXTtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXREZXZpY2UoaSk7XG4gICAgICAgICAgICAgICAgICAgIGxldCBpbmZvID0gdGhpcy5kZXZpY2VJbmZvKCk7XG4gICAgICAgICAgICAgICAgICAgIGluZm8uaWQgPSBpO1xuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpbmZvKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZpbmFsbHkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGV2aWNlKGN1cnJlbnQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBnZm9yOiByZXF1aXJlKFwiLi9tYWtlR2ZvclwiKShhZilcbiAgICB9KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBleHQ7Il19
