{"version":3,"sources":["scope.js"],"names":[],"mappings":"AAAA,YAAY,CAAC;;AACb,IAAI,QAAQ,GAAG,OAAO,CAAC,UAAU,CAAC,CAAC;AACnC,IAAI,CAAC,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC;;AAE1B,IAAI,WAAW,GAAG,EAAE,CAAC;;AAErB,SAAS,KAAK,CAAC,CAAC,EAAE;AACd,QAAI,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,EAAE;AACjB,aAAK,CAAC,KAAK,EAAE,CAAC;AACd,YAAI;AACA,gBAAI,MAAM,GAAG,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;AAC3B,gBAAI,CAAC,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,UAAU,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE;AACjD,uBAAO,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,CAC1B,IAAI,CAAC,YAAW;AACb,2BAAO,KAAK,CAAC;iBAChB,CAAC,CACD,OAAO,CAAC,YAAW;AAChB,yBAAK,CAAC,GAAG,EAAE,CAAC;iBACf,CAAC,CAAC;aACV,MACI;AACD,qBAAK,CAAC,GAAG,EAAE,CAAC;AACZ,uBAAO,KAAK,CAAC;aAChB;SACJ,CACD,OAAM,CAAC,EAAE;AACL,iBAAK,CAAC,GAAG,EAAE,CAAC;AACZ,kBAAM,CAAC,CAAC;SACX;KACJ;CACJ;;AAED,KAAK,CAAC,KAAK,GAAG,YAAW;AACrB,eAAW,CAAC,IAAI,CAAC,IAAI,GAAG,EAAE,CAAC,CAAC;AAC5B,WAAO,KAAK,CAAC;CAChB,CAAC;;AAEF,KAAK,CAAC,GAAG,GAAG,YAAW;AACnB,QAAI,WAAW,CAAC,MAAM,EAAE;AACpB,YAAI,GAAG,GAAG,WAAW,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;AAC9C,mBAAW,CAAC,MAAM,EAAE,CAAC;AACrB,YAAI,CAAC,GAAG,CAAC,CAAC;KACb;AACD,WAAO,KAAK,CAAC;CAChB,CAAC;;AAEF,KAAK,CAAC,QAAQ,GAAG,UAAS,KAAK,EAAE;AAC7B,QAAI,WAAW,CAAC,MAAM,IAAI,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,UAAU,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE;AACrE,YAAI,GAAG,GAAG,WAAW,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;AAC9C,WAAG,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;KAClB;CACJ,CAAC;;AAEF,KAAK,CAAC,MAAM,GAAG,UAAS,KAAK,EAAE;AAC3B,QAAI,WAAW,CAAC,MAAM,IAAI,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,EAAE;AACzC,YAAI,GAAG,GAAG,WAAW,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;AAC9C,WAAG,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;KACrB;AACD,WAAO,KAAK,CAAC;CAChB,CAAC;;AAEF,SAAS,IAAI,CAAC,MAAM,EAAE;;;;;;AAClB,6BAAkB,MAAM,CAAC,MAAM,EAAE,8HAAE;gBAA1B,KAAK;;AACV,iBAAK,CAAC,IAAI,EAAE,CAAC;SAChB;;;;;;;;;;;;;;;CACJ;;AAED,MAAM,CAAC,OAAO,GAAG,KAAK,CAAC","file":"scope.js","sourcesContent":["\"use strict\";\nlet Bluebird = require(\"bluebird\");\nlet _ = require(\"lodash\");\n\nlet temporaries = [];\n\nfunction scope(f) {\n    if (_.isFunction(f)) {\n        scope.begin();\n        try {\n            let result = f.call(scope);\n            if (_.isObject(result) && _.isFunction(result.then)) {\n                return Bluebird.resolve(result)\n                    .then(function() {\n                        return scope;\n                    })\n                    .finally(function() {\n                        scope.end();\n                    });\n            }\n            else {\n                scope.end();\n                return scope;\n            }\n        }\n        catch(e) {\n            scope.end();\n            throw e;\n        }\n    }\n}\n\nscope.begin = function() {\n    temporaries.push(new Set());\n    return scope;\n};\n\nscope.end = function() {\n    if (temporaries.length) {\n        let set = temporaries[temporaries.length - 1];\n        temporaries.length--;\n        free(set);\n    }\n    return scope;\n};\n\nscope.register = function(array) {\n    if (temporaries.length && _.isObject(array) && _.isFunction(array.free)) {\n        let set = temporaries[temporaries.length - 1];\n        set.add(array);\n    }\n};\n\nscope.result = function(array) {\n    if (temporaries.length && _.isObject(array)) {\n        let set = temporaries[temporaries.length - 1];\n        set.delete(array);\n    }\n    return scope;\n};\n\nfunction free(arrays) {\n    for (let array of arrays.values()) {\n        array.free();\n    }\n}\n\nmodule.exports = scope;"],"sourceRoot":"/source/"}